<div class="grid p-4 md:p-6 fadein animation-duration-500">
  <!-- Peace of Mind Header -->
  <div class="col-12 mb-4">
    <div class="flex flex-column md:flex-row justify-content-between align-items-start md:align-items-center gap-4">
      <div>
        <h1 class="text-3xl font-bold text-900 m-0 tracking-tight">GST Buddy</h1>
        <p class="text-secondary mt-2 text-lg m-0">
          Rule 37 â€” 180-day ITC Reversal & Interest Calculator
        </p>
      </div>
    </div>
  </div>

  <!-- Status Banner (Peace of Mind) -->
  @if (statusMessage()) {
    <div class="col-12 mb-4">
      <div
        class="buddy-status-card p-4 border-round-xl"
        [ngClass]="statusSeverity() === 'teal' ? 'buddy-status-teal' : 'buddy-status-amber'"
      >
        <div class="flex align-items-center gap-3">
          @if (statusSeverity() === 'teal') {
            <i class="pi pi-check-circle text-4xl"></i>
          } @else {
            <i class="pi pi-exclamation-triangle text-4xl"></i>
          }
          <div>
            <h2 class="text-2xl font-bold m-0">{{ statusMessage() }}</h2>
            <p class="text-600 m-0 mt-1">
              @if (statusSeverity() === 'teal') {
                No ITC reversal or interest payable for the uploaded ledgers.
              } @else {
                Review the details below for ITC reversal and interest amounts.
              }
            </p>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Tabs: New Calculation / History -->
  <div class="col-12">
    <div class="flex gap-2 mb-4 border-bottom-1 surface-border pb-3">
      <button
        pButton
        label="New Calculation"
        icon="pi pi-file-edit"
        [outlined]="activeTab() !== 'new'"
        (click)="activeTab.set('new')"
      ></button>
      <button
        pButton
        label="Saved Calculations"
        icon="pi pi-history"
        [outlined]="activeTab() !== 'history'"
        (click)="activeTab.set('history')"
      ></button>
    </div>

    @if (activeTab() === 'new') {
      <div>
        <!-- How it works -->
        <div class="buddy-info-card mb-4 p-4">
          <div class="flex align-items-start gap-3">
            <i class="pi pi-info-circle text-2xl text-primary"></i>
            <div class="text-sm text-700">
              <p class="font-medium mb-1">How it works:</p>
              <ul class="list-disc list-inside space-y-1 text-600">
                <li>Upload one or multiple supplier ledgers from Tally or Busy in Excel format</li>
                <li>The system parses Date, Debit (Payment), and Credit (Purchase) columns</li>
                <li>Interest is calculated at 18% p.a. on ITC amount (18/118 of purchase value)</li>
                <li>ITC reversal applies only to unpaid amounts beyond 180 days</li>
                <li>Calculations are saved and available for 7 days</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- As on Date -->
        <div class="surface-50 border-1 surface-border border-round p-4 mb-4">
          <label class="block mb-2 font-medium text-800">As on Date</label>
          <input
            type="date"
            pInputText
            [ngModel]="asOnDate()"
            (ngModelChange)="asOnDate.set($event)"
            [disabled]="isProcessing()"
            class="w-full"
          />
          <p class="text-sm text-500 mt-2 m-0">Set the date for calculating delays on unpaid amounts</p>
        </div>

        <!-- Document Upload -->
        <div class="surface-50 border-1 surface-border border-round p-4 mb-4">
          <app-document-upload
            [disabled]="isProcessing()"
            (filesSelected)="onFilesSelected($event)"
          />
          @if (fileNames().length > 0 && !error()) {
            <div class="mt-3 text-sm text-green-600 font-medium text-center">
              <p class="m-0">{{ fileNames().length }} file(s) uploaded</p>
            </div>
          }
        </div>

        <!-- Processing -->
        @if (isProcessing()) {
          <div class="flex justify-content-center py-8">
            <div class="flex flex-column align-items-center gap-4">
              <i class="pi pi-spin pi-spinner" style="font-size: 3rem;"></i>
              <p class="text-600 font-medium m-0">Processing your file...</p>
            </div>
          </div>
        }

        <!-- Error -->
        @if (error()) {
          <p-message severity="warn" [text]="error()!" styleClass="w-full mb-4"></p-message>
        }

        <!-- Results -->
        @if (results().length > 0 && !isProcessing()) {
          <div class="mt-6 pt-6 border-top-1 surface-border">
            <h2 class="text-2xl font-bold text-900 mb-4 flex align-items-center gap-2">
              <i class="pi pi-calculator text-primary"></i>
              Calculation Results
            </h2>
            <app-compliance-view
              [results]="results()"
              [runId]="runId()"
              [showExportAll]="true"
              (exportAll)="downloadExport()"
              (exportLedger)="onExportLedger($event)"
            />
            <div class="buddy-success-card mt-4 p-4">
              <p class="text-700 text-sm m-0">
                <span class="font-semibold">Saved!</span> Your calculation has been saved and will be available in the History tab for 7 days.
              </p>
            </div>
          </div>
        }
      </div>
    } @else {
      <app-calculation-history />
    }
  </div>
</div>
