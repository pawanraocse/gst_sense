# =============================================================================
# Budget Environment - Docker Compose (JAR Rsync Mode)
# =============================================================================
# Uses extends from base.yml to build images locally on EC2.
# JARs are rsynced from local Mac to EC2, then built on EC2.
#
# Prerequisites:
# - JARs built: mvn clean package -DskipTests
# - JARs + Dockerfiles rsynced to EC2
# =============================================================================

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

# =============================================================================
# Services
# =============================================================================

services:


  # ============================================================================
  # OpenTelemetry Collector
  # ============================================================================
  otel-collector:
    extends:
      file: docker-compose.base.yml
      service: otel-collector

  # ============================================================================
  # Eureka Service Discovery
  # ============================================================================
  eureka-server:
    extends:
      file: docker-compose.base.yml
      service: eureka-server
    # Optimized JVM for faster startup on t3.small
    entrypoint: ["java", "-Xmx128m", "-Xms64m", "-XX:+UseSerialGC", "-XX:+TieredCompilation", "-XX:TieredStopAtLevel=1", "-jar", "/app/app.jar"]

  # ============================================================================
  # Gateway - Connect to ElastiCache
  # ============================================================================
  gateway-service:
    extends:
      file: docker-compose.base.yml
      service: gateway-service
    restart: unless-stopped
    # Bypass entrypoint that fetches from wrong SSM path
    entrypoint: ["java", "-Xmx160m", "-Xms96m", "-XX:+UseSerialGC", "-XX:+TieredCompilation", "-XX:TieredStopAtLevel=1", "-XX:+UseContainerSupport", "-jar", "/app/app.jar"]
    environment:
      SPRING_APPLICATION_NAME: gateway-service
      SERVER_PORT: 8080
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "false"
      EUREKA_INSTANCE_HOSTNAME: gateway-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318/v1/traces
      # Production logging (change to DEBUG for troubleshooting)
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: INFO
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_CLOUD_GATEWAY: INFO
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,metrics
      MANAGEMENT_ENDPOINTS_WEB_BASE_PATH: /actuator
      # Cognito OAuth2
      COGNITO_ISSUER_URI: ${COGNITO_ISSUER_URI}
      COGNITO_JWKS_URI: ${COGNITO_JWKS_URI}
      COGNITO_USER_POOL_ID: ${COGNITO_USER_POOL_ID}
      COGNITO_CLIENT_ID: ${COGNITO_SPA_CLIENT_ID}
      COGNITO_DOMAIN: ${COGNITO_DOMAIN}
    depends_on:
      eureka-server:
        condition: service_healthy

  # ============================================================================
  # Backend - Connect to RDS and ElastiCache
  # ============================================================================
  backend-service:
    extends:
      file: docker-compose.base.yml
      service: backend-service
    restart: unless-stopped
    # Optimized JVM for t3.small
    entrypoint: ["java", "-Xmx192m", "-Xms128m", "-XX:+UseSerialGC", "-XX:+TieredCompilation", "-XX:TieredStopAtLevel=1", "-XX:+UseContainerSupport", "-jar", "/app/app.jar"]
    environment:
      SPRING_APPLICATION_NAME: backend-service
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      SPRING_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=require
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "false"
      EUREKA_INSTANCE_HOSTNAME: backend-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318/v1/traces
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,metrics
      MANAGEMENT_ENDPOINTS_WEB_BASE_PATH: /actuator
      server.port: 8082
      # Redis
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # Cognito
      COGNITO_USER_POOL_ID: ${COGNITO_USER_POOL_ID}
      COGNITO_ISSUER_URI: ${COGNITO_ISSUER_URI}
    depends_on:
      eureka-server:
        condition: service_healthy

  # ============================================================================
  # Auth - Connect to RDS and ElastiCache
  # ============================================================================
  auth-service:
    extends:
      file: docker-compose.base.yml
      service: auth-service
    restart: unless-stopped
    # Optimized JVM for t3.small
    entrypoint: ["java", "-Xmx192m", "-Xms128m", "-XX:+UseSerialGC", "-XX:+TieredCompilation", "-XX:TieredStopAtLevel=1", "-XX:+UseContainerSupport", "-jar", "/app/app.jar"]
    environment:
      SPRING_APPLICATION_NAME: auth-service
      SPRING_PROFILES_ACTIVE: ${AUTH_PROFILE:-}
      SPRING_DATASOURCE_URL: jdbc:postgresql://${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=require
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}
      COGNITO_USER_POOL_ID: ${COGNITO_USER_POOL_ID}
      COGNITO_CLIENT_ID: ${COGNITO_CLIENT_ID}
      COGNITO_CLIENT_SECRET: ${COGNITO_CLIENT_SECRET}
      COGNITO_DOMAIN: ${COGNITO_DOMAIN}
      COGNITO_REDIRECT_URI: ${COGNITO_REDIRECT_URI}
      COGNITO_LOGOUT_REDIRECT_URL: ${COGNITO_LOGOUT_REDIRECT_URL}
      COGNITO_JWKS_URI: ${COGNITO_JWKS_URI}
      COGNITO_ISSUER_URI: ${COGNITO_ISSUER_URI}
      EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "false"
      EUREKA_INSTANCE_HOSTNAME: auth-service
      server.port: 8081
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318/v1/traces
      # Production logging (change to DEBUG for troubleshooting)
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: INFO
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,metrics
      MANAGEMENT_ENDPOINTS_WEB_BASE_PATH: /actuator
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT:-6379}
    depends_on:
      eureka-server:
        condition: service_healthy


networks:
  app-network:
    driver: bridge
